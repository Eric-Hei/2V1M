<!doctype html>
<html lang="fr">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>2V1M</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;500;700&family=Inter:wght@400;500;600&display=swap');

    :root {
      /* Palette - Modern Dark "Slate" Theme */
      --bg-app: #0f172a;
      /* Slate 900 */
      --bg-card: #1e293b;
      /* Slate 800 */
      --bg-input: #334155;
      /* Slate 700 */

      --txt-main: #f8fafc;
      /* Slate 50 */
      --txt-muted: #94a3b8;
      /* Slate 400 */

      --accent-primary: #6366f1;
      /* Indigo 500 */
      --accent-hover: #4f46e5;
      /* Indigo 600 */
      --accent-glow: rgba(99, 102, 241, 0.5);

      --danger: #ef4444;
      /* Red 500 */
      --success: #10b981;
      /* Emerald 500 */
      --warning: #f59e0b;
      /* Amber 500 */

      --radius-lg: 24px;
      --radius-md: 16px;
      --radius-sm: 12px;

      --shadow-elevation: 0 20px 25px -5px rgba(0, 0, 0, 0.4), 0 8px 10px -6px rgba(0, 0, 0, 0.2);
      --shadow-glow: 0 0 20px var(--accent-glow);

      --font-display: 'Space Grotesk', system-ui, sans-serif;
      --font-body: 'Inter', system-ui, sans-serif;
    }

    /* RESET & BASE */
    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      margin: 0;
      background-color: var(--bg-app);
      color: var(--txt-main);
      font-family: var(--font-body);
      font-size: 16px;
      line-height: 1.5;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      overflow-x: hidden;
    }

    h1,
    h2,
    h3 {
      margin: 0;
      font-family: var(--font-display);
      font-weight: 700;
    }

    p {
      margin: 0;
      color: var(--txt-muted);
    }

    /* LAYOUT & UTILS */
    .app-container {
      width: 100%;
      max-width: 540px;
      margin: 0 auto;
      padding: 20px;
      flex: 1;
      display: flex;
      flex-direction: column;
      position: relative;
    }

    .hidden {
      display: none !important;
    }

    .fade-in {
      animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* COMPONENTS */
    .brand-title {
      font-size: 2.5rem;
      text-align: center;
      background: linear-gradient(135deg, #fff 0%, #cbd5e1 100%);
      background-clip: text;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 8px;
      letter-spacing: -0.03em;
    }

    .tagline {
      text-align: center;
      margin-bottom: 32px;
      font-size: 1rem;
      opacity: 0.8;
    }

    /* Cards & Containers */
    .view-section {
      display: none;
      /* Managed by JS */
      flex-direction: column;
      gap: 24px;
      width: 100%;
    }

    .view-section.active {
      display: flex;
    }

    .card {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      padding: 24px;
      box-shadow: var(--shadow-elevation);
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    /* Forms */
    .input-group {
      margin-bottom: 20px;
      text-align: left;
    }

    .input-group label {
      display: block;
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--txt-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    input,
    textarea,
    select {
      width: 100%;
      background: var(--bg-input);
      border: 2px solid transparent;
      color: white;
      padding: 14px 16px;
      border-radius: var(--radius-md);
      font-family: inherit;
      font-size: 1rem;
      transition: all 0.2s;
    }

    input::placeholder,
    textarea::placeholder {
      color: rgba(255, 255, 255, 0.3);
    }

    input:focus,
    textarea:focus,
    select:focus {
      outline: none;
      border-color: var(--accent-primary);
      background: rgba(99, 102, 241, 0.1);
      box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.15);
    }

    textarea {
      resize: vertical;
      min-height: 100px;
    }

    /* Buttons */
    button {
      width: 100%;
      cursor: pointer;
      border: none;
      font-family: var(--font-display);
      font-weight: 600;
      font-size: 1.05rem;
      padding: 16px;
      border-radius: var(--radius-md);
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn-primary {
      background: var(--accent-primary);
      color: white;
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
    }

    .btn-primary:active {
      transform: scale(0.98);
    }

    .btn-primary:hover {
      background: var(--accent-hover);
      box-shadow: var(--shadow-glow);
    }

    .btn-secondary {
      background: rgba(255, 255, 255, 0.08);
      color: var(--txt-main);
    }

    .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.12);
    }

    .btn-danger {
      background: rgba(239, 68, 68, 0.15);
      color: var(--danger);
    }

    .btn-danger:hover {
      background: rgba(239, 68, 68, 0.25);
    }

    /* Tab Switcher */
    .tabs {
      display: flex;
      background: var(--bg-input);
      padding: 4px;
      border-radius: var(--radius-md);
      margin-bottom: 24px;
    }

    .tab-btn {
      flex: 1;
      background: transparent;
      color: var(--txt-muted);
      padding: 10px;
      border-radius: var(--radius-sm);
      font-size: 0.95rem;
    }

    .tab-btn.active {
      background: var(--bg-card);
      color: var(--txt-main);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    /* Lists */
    .list-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .list-item:last-child {
      border-bottom: none;
    }

    /* Game Specific Elements */
    .statement-card {
      background: var(--bg-input);
      padding: 20px;
      border-radius: var(--radius-md);
      margin-bottom: 12px;
      cursor: pointer;
      border: 2px solid transparent;
      transition: all 0.2s;
      text-align: left;
    }

    .statement-card:hover {
      transform: translateY(-2px);
      background: #3c4c66;
    }

    .statement-card.selected {
      border-color: var(--accent-primary);
      background: rgba(99, 102, 241, 0.1);
    }

    .status-pill {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 99px;
      font-size: 0.8rem;
      font-weight: 600;
      background: rgba(255, 255, 255, 0.1);
      margin-bottom: 20px;
    }

    /* Radio Tiles for "Pick the Lie" */
    .radio-tiles {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 8px;
      margin-top: 10px;
    }

    .radio-tile-label {
      cursor: pointer;
      background: var(--bg-input);
      padding: 12px;
      border-radius: var(--radius-sm);
      text-align: center;
      font-weight: 600;
      transition: 0.2s;
      border: 1px solid transparent;
    }

    .radio-tile-label:has(input:checked) {
      background: var(--accent-primary);
      color: white;
      border-color: var(--accent-primary);
    }

    .radio-tile-label input {
      display: none;
    }

    /* Results */
    .result-row {
      background: rgba(255, 255, 255, 0.03);
      margin-bottom: 8px;
      padding: 12px 16px;
      border-radius: var(--radius-md);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .result-row.winner {
      background: linear-gradient(90deg, rgba(16, 185, 129, 0.1), transparent);
      border-left: 3px solid var(--success);
    }

    .score-badge {
      font-family: var(--font-display);
      font-weight: 700;
      font-size: 1.1rem;
    }

    /* Live Scoreboard */
    .live-scoreboard {
      position: fixed;
      top: 60px;
      right: 20px;
      width: 280px;
      max-height: calc(100vh - 80px);
      overflow-y: auto;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 100;
    }

    .live-scoreboard h3 {
      margin: 0 0 12px 0;
      font-size: 1rem;
      text-align: center;
      color: var(--txt-primary);
    }

    .live-scoreboard.hidden {
      display: none;
    }

    .score-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px;
      margin-bottom: 4px;
      border-radius: 6px;
      background: var(--bg-primary);
      font-size: 0.85rem;
    }

    .score-row.top {
      background: linear-gradient(90deg, rgba(16, 185, 129, 0.15), transparent);
      border-left: 3px solid var(--success);
    }

    .score-row .player-info {
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1;
      min-width: 0;
    }

    .score-row .rank {
      font-weight: 700;
      width: 24px;
      color: var(--txt-muted);
    }

    .score-row .nickname {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .score-row .points {
      font-weight: 700;
      font-family: var(--font-display);
      color: var(--accent-primary);
    }

    .score-details {
      font-size: 0.75rem;
      color: var(--txt-muted);
      margin-left: 32px;
    }

    /* Player Status Badges */
    .player-status-section {
      margin-top: 16px;
      padding-top: 12px;
      border-top: 1px solid var(--border);
    }

    .player-status-section h4 {
      margin: 0 0 10px 0;
      font-size: 0.85rem;
      text-align: center;
      color: var(--txt-muted);
    }

    .player-status-row {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 8px;
      margin-bottom: 4px;
      border-radius: 6px;
      font-size: 0.8rem;
      background: rgba(255,255,255,0.03);
    }

    .player-status-row .ps-name {
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .player-status-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 0.7rem;
      font-weight: 600;
      white-space: nowrap;
    }

    .player-status-badge.status-waiting   { background: rgba(150,150,150,0.15); color: var(--txt-muted); }
    .player-status-badge.status-writing    { background: rgba(255,193,7,0.15); color: #ffc107; }
    .player-status-badge.status-ready      { background: rgba(76,175,80,0.15); color: #4caf50; }
    .player-status-badge.status-narrator   { background: rgba(156,39,176,0.15); color: #ce93d8; }
    .player-status-badge.status-listening  { background: rgba(33,150,243,0.15); color: #64b5f6; }
    .player-status-badge.status-voting     { background: rgba(255,152,0,0.15); color: #ffb74d; }
    .player-status-badge.status-voted      { background: rgba(76,175,80,0.15); color: #4caf50; }
    .player-status-badge.status-done       { background: rgba(96,125,139,0.15); color: #90a4ae; }
    .player-status-badge.status-finished   { background: rgba(96,125,139,0.15); color: #90a4ae; }

    @media (max-width: 768px) {
      .live-scoreboard {
        position: static;
        width: 100%;
        max-height: none;
        margin-bottom: 20px;
      }
    }

    /* Header Info */
    .session-header {
      position: fixed;
      top: 20px;
      right: 20px;
      display: flex;
      gap: 8px;
      align-items: center;
      font-size: 0.85rem;
      z-index: 50;
      flex-direction: column;
      align-items: flex-end;
    }

    .session-info {
      opacity: 0.6;
      font-size: 0.75rem;
    }

    .group-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 20px;
      font-weight: 600;
      font-size: 0.85rem;
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      color: white;
      box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
    }

    .group-badge-icon {
      font-size: 1rem;
    }

    /* Group colors */
    .group-color-1 { background: linear-gradient(135deg, #6366f1, #8b5cf6); }
    .group-color-2 { background: linear-gradient(135deg, #10b981, #14b8a6); }
    .group-color-3 { background: linear-gradient(135deg, #f59e0b, #f97316); }
    .group-color-4 { background: linear-gradient(135deg, #ec4899, #f43f5e); }
    .group-color-5 { background: linear-gradient(135deg, #3b82f6, #06b6d4); }
    .group-color-6 { background: linear-gradient(135deg, #8b5cf6, #d946ef); }

    .offline-badge {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--danger);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      z-index: 9999;
      display: flex;
      align-items: center;
      gap: 8px;
      animation: slideUp 0.3s ease-out;
    }

    @keyframes slideUp {
      from {
        transform: translate(-50%, 20px);
        opacity: 0;
      }

      to {
        transform: translate(-50%, 0);
        opacity: 1;
      }
    }
  </style>
</head>

<body>
  <!-- Top Right Meta -->
  <div class="session-header" id="sessionMeta"></div>

  <!-- Offline Badge -->
  <div id="offline-badge" class="offline-badge hidden">
    <span>‚ö†Ô∏è Connexion perdue...</span>
  </div>

  <!-- Live Scoreboard (for spectators and during game) -->
  <div id="live-scoreboard" class="live-scoreboard hidden" role="complementary" aria-label="Tableau de bord en direct">
    <h3>üèÜ Classement Live</h3>
    <div id="live-scores-list"></div>
    <div class="player-status-section" id="player-status-panel" aria-live="polite">
      <h4>üë• Statuts des joueurs</h4>
      <div id="player-status-list"></div>
    </div>
  </div>

  <div class="app-container">

    <!-- VIEW: WELCOME / LOBBY ENTRY -->
    <section id="view-welcome" class="view-section active fade-in">
      <div>
        <h1 class="brand-title">2V1M</h1>
        <p class="tagline">Deux V√©rit√©s, Un Mensonge.</p>
        <p style="text-align: center; font-size: 0.75rem; color: var(--txt-muted); margin-top: 8px;">v0.1.22</p>
      </div>

      <div class="card">
        <div class="tabs">
          <button class="tab-btn active" onclick="switchEntryMode('create')">Cr√©er</button>
          <button class="tab-btn" onclick="switchEntryMode('join')">Rejoindre</button>
        </div>

        <!-- CREATE FORM -->
        <div id="panel-create">
          <div style="text-align: center; margin: 30px 0;">
            <p style="margin-bottom: 20px;">Lance une nouvelle partie instantan√©ment.</p>
            <div class="input-group">
              <label>Code Partie (Optionnel)</label>
              <input id="inp-code-create" placeholder="Auto" maxlength="9"
                style="text-transform:uppercase; letter-spacing: 2px; text-align: center; font-family: var(--font-display); font-weight: 700;">
            </div>
            <button class="btn-primary" id="btn-create">Cr√©er une Partie</button>
          </div>
        </div>

        <!-- JOIN FORM -->
        <div id="panel-join" class="hidden">
          <div class="input-group">
            <label>Code Partie</label>
            <input id="inp-code" placeholder="Ex: A1B2C" maxlength="5"
              style="text-transform:uppercase; letter-spacing: 2px; text-align: center; font-family: var(--font-display); font-weight: 700;">
          </div>

          <div class="input-group">
            <label>Ton Pseudo</label>
            <input id="inp-nick" placeholder="Surnom" maxlength="20">
          </div>

          <div class="input-group">
            <label>Groupe</label>
            <select id="inp-group">
              <option value="" disabled selected>Choisir un groupe...</option>
            </select>
          </div>
          <label
            style="display:flex; align-items:center; gap:10px; margin-bottom: 20px; font-size: 0.9rem; color: var(--txt-muted);">
            <input type="checkbox" id="chk-newgroup" style="width: auto; margin:0;"> Cr√©er un nouveau groupe
          </label>

          <button class="btn-primary" id="btn-join">Rejoindre</button>
        </div>
      </div>
    </section>

    <!-- VIEW: LOBBY -->
    <section id="view-lobby" class="view-section fade-in">
      <h2 style="text-align: center;">Salle d'attente</h2>
      <div style="display: flex; justify-content: center; gap: 8px; margin-bottom: 16px;">
        <span class="status-pill" id="lbl-lobby-code">CODE: ----</span>
        <span class="status-pill" id="lbl-lobby-players">0 Joueurs</span>
      </div>

      <!-- Statements Input -->
      <div class="card" id="card-prep-statements">
        <h3>Tes √ânonc√©s</h3>
        <p style="margin-bottom: 16px; font-size: 0.9rem;">√âcris 2 v√©rit√©s et 1 mensonge sur toi.</p>

        <div style="display: grid; gap: 12px;">
          <textarea id="txt-s1" placeholder="√ânonc√© 1..." rows="2" style="min-height: 70px;"></textarea>
          <textarea id="txt-s2" placeholder="√ânonc√© 2..." rows="2" style="min-height: 70px;"></textarea>
          <textarea id="txt-s3" placeholder="√ânonc√© 3..." rows="2" style="min-height: 70px;"></textarea>
        </div>

        <div style="margin-top: 20px;">
          <p style="font-size: 0.85rem; font-weight: 600; text-transform: uppercase;">Lequel est le mensonge ?</p>
          <div class="radio-tiles">
            <label class="radio-tile-label">
              <input type="radio" name="lie" value="0"> <span>#1</span>
            </label>
            <label class="radio-tile-label">
              <input type="radio" name="lie" value="1"> <span>#2</span>
            </label>
            <label class="radio-tile-label">
              <input type="radio" name="lie" value="2" checked> <span>#3</span>
            </label>
          </div>
        </div>

        <button class="btn-primary" style="margin-top: 24px;" id="btn-submit-statements">Valider & Pr√™t</button>
        <p id="msg-prep-status" style="text-align: center; margin-top: 12px; color: var(--success);" class="hidden">‚úÖ
          √ânonc√©s envoy√©s ! En attente des autres...</p>
      </div>

      <div class="card">
        <h3>Participants</h3>
        <div id="list-lobby-players" style="margin-top: 12px;"></div>
      </div>

      <!-- Spectator Link -->
      <div class="card" id="card-spectator-link" style="background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(168, 85, 247, 0.1));">
        <h3 style="font-size: 0.95rem;">üì∫ Mode Spectateur</h3>
        <p style="font-size: 0.85rem; margin-bottom: 12px; color: var(--txt-muted);">
          Partagez ce lien pour suivre la partie en direct sur un autre √©cran :
        </p>
        <div style="display: flex; gap: 8px;">
          <input type="text" id="inp-spectator-url" readonly style="flex: 1; font-size: 0.85rem; background: var(--bg-primary);" value="">
          <button class="btn-secondary" id="btn-copy-spectator" style="white-space: nowrap;">üìã Copier</button>
        </div>
        <p id="msg-copy-success" class="hidden" style="text-align: center; margin-top: 8px; color: var(--success); font-size: 0.8rem;">‚úÖ Lien copi√© !</p>
      </div>

      <div style="text-align:center; margin-top:20px;">
        <p class="hidden" id="msg-lobby-autostart" style="font-size:0.8rem; color:var(--txt-muted);">La partie d√©marrera
          quand tout le monde sera pr√™t...</p>
      </div>
    </section>

    <!-- VIEW: GAME QUESTIONING -->
    <section id="view-game" class="view-section fade-in">
      <div style="text-align: center; margin-bottom: 20px;">
        <span class="status-pill" style="background: var(--accent-primary);">En Jeu</span>
        <h2 id="lbl-narrator-name">Au tour de...</h2>
      </div>

      <div class="card">
        <p style="text-align: center; margin-bottom: 20px;">Quelle affirmation est un <strong>mensonge</strong> ?</p>
        <div id="list-vote-options" style="display: flex; flex-direction: column; gap: 12px;"></div>
        <p id="msg-host-wait" class="hidden"
          style="text-align:center; margin-top:20px; color:var(--txt-muted); font-size:0.9rem;">En attente de la
          soumission du narrateur...</p>
      </div>

      <p id="msg-vote-wait" style="text-align: center; margin-top: 20px;" class="hidden">Vote enregistr√©. En attente du
        r√©sultat...</p>
    </section>

    <!-- VIEW: REVEAL -->
    <section id="view-reveal" class="view-section fade-in">
      <div style="text-align: center; margin-bottom: 20px;">
        <h1 style="font-size: 3rem; margin-bottom: 10px;">üë∫</h1>
        <h2>R√©sultat</h2>
      </div>

      <div class="card" id="card-reveal-info" style="text-align: center;">
        <!-- Filled by JS -->
      </div>

      <!-- Timer or Button to next -->
      <p style="text-align: center; margin-top: 20px; opacity:0.6;">Le prochain tour va d√©marrer...</p>
    </section>

    <!-- VIEW: SCORES -->
    <section id="view-scores" class="view-section fade-in">
      <h2 style="text-align: center; margin-bottom: 24px;">Classement</h2>
      <div id="list-scores" style="display: flex; flex-direction: column; gap: 8px;"></div>
    </section>

  </div>

  <!-- AUDIO -->
  <audio id="sfx-reveal" src="" preload="auto"></audio>

  <script>
    /* --- STATE & UTILS --- */
    const state = {
      view: 'welcome', // welcome, lobby, game, reveal, scores
      code: null,
      playerId: null,
      snapshot: null,
      myVotes: new Set(),
      hasSubmittedPrep: false,
      isOffline: false,
      isSpectatorMode: false,
      _renderedRoundId: null,
      _renderedVoteCount: -1,
      _renderedRoundStatus: null
    };

    const $ = (id) => document.getElementById(id);

    /* --- COOKIE HELPERS --- */
    function setSessionCookie(token) {
      document.cookie = `2v1m_session=${token}; path=/; max-age=${60 * 60 * 24}; SameSite=Lax`;
    }

    function getSessionCookie() {
      const match = document.cookie.match(/(^|;\s*)2v1m_session=([^;]+)/);
      return match ? match[2] : null;
    }

    function clearSessionCookie() {
      document.cookie = '2v1m_session=; path=/; max-age=0; SameSite=Lax';
    }

    /* --- URL NAVIGATION --- */
    function navigate(path, replace = false) {
      if (replace) {
        history.replaceState(null, '', path);
      } else {
        history.pushState(null, '', path);
      }
    }

    /* --- INIT FROM URL ON PAGE LOAD --- */
    async function initFromUrl() {
      const path = window.location.pathname;

      // /admin/:code ‚Üí spectator/admin mode
      const adminMatch = path.match(/^\/admin\/([A-Z0-9]+)$/i);
      if (adminMatch) {
        const code = adminMatch[1].toUpperCase();
        state.code = code;
        state.playerId = null;
        state.isSpectatorMode = true;
        startPolling();
        return;
      }

      // /spectate/:code ‚Üí legacy, redirect to /admin/:code
      const spectateMatch = path.match(/^\/spectate\/([A-Z0-9]+)$/i);
      if (spectateMatch) {
        const code = spectateMatch[1].toUpperCase();
        navigate(`/admin/${code}`, true);
        state.code = code;
        state.playerId = null;
        state.isSpectatorMode = true;
        startPolling();
        return;
      }

      // /party/:code ‚Üí player mode, restore session from cookie
      const partyMatch = path.match(/^\/party\/([A-Z0-9]+)$/i);
      if (partyMatch) {
        const code = partyMatch[1].toUpperCase();
        const token = getSessionCookie();
        if (token) {
          try {
            const session = await api(`/sessions/${token}`);
            if (session && session.code.toUpperCase() === code) {
              state.code = code;
              state.playerId = session.playerId;
              startPolling();
              return;
            }
          } catch (e) {
            console.warn('Session restore failed:', e);
          }
        }
        // Session not found or invalid ‚Üí show welcome with pre-filled code
        clearSessionCookie();
        navigate('/', true);
        $('inp-code').value = partyMatch[1].toUpperCase();
        return;
      }

      // /join/:code ‚Üí legacy, pre-fill code
      const joinMatch = path.match(/^\/join\/([A-Z0-9]+)$/i);
      if (joinMatch) {
        const code = joinMatch[1].toUpperCase();
        $('inp-code').value = code;
        return;
      }

      // / ‚Üí welcome page (default, nothing to do)
    }

    const api = async (endpoint, method = 'GET', body = null) => {
      const headers = { 'Content-Type': 'application/json' };
      if (state.playerId) headers['x-player-id'] = state.playerId;

      try {
        const res = await fetch(`/api/v1${endpoint}`, { method, headers, body: body ? JSON.stringify(body) : null });
        const data = await res.json();
        if (!res.ok) throw new Error(data.message || 'Error');
        setOffline(false);
        return data;
      } catch (e) {
        // If it's a polling GET, we might want to suppress the alert and show offline status
        if (method === 'GET' && endpoint.startsWith('/parties/')) {
          console.warn('Polling failed:', e);
          throw e; // let caller handle or ignore
        }

        alert('Erreur: ' + e.message);
        console.error(e);
        throw e;
      }
    };

    function setOffline(isOffline) {
      if (state.isOffline === isOffline) return;
      state.isOffline = isOffline;
      const badge = $('offline-badge');
      if (isOffline) badge.classList.remove('hidden');
      else badge.classList.add('hidden');
    }

    /* --- UI CONTROL --- */
    function switchView(viewName) {
      if (state.view === viewName) return;
      document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
      const target = $(`view-${viewName}`);
      if (target) {
        target.classList.add('active');
        // Re-trigger animation
        target.style.animation = 'none';
        target.offsetHeight; /* trigger reflow */
        target.style.animation = null;
      }
      state.view = viewName;
      window.scrollTo(0, 0);
    }

    function switchEntryMode(mode) {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      if (mode === 'create') {
        $('panel-create').classList.remove('hidden');
        $('panel-join').classList.add('hidden');
        document.querySelector('button[onclick="switchEntryMode(\'create\')"]').classList.add('active');
      } else {
        $('panel-create').classList.add('hidden');
        $('panel-join').classList.remove('hidden');
        document.querySelector('button[onclick="switchEntryMode(\'join\')"]').classList.add('active');
        refreshGroups();
      }
    }

    // Attach to window for onclick handlers
    window.switchEntryMode = switchEntryMode;

    /* --- GAME LOGIC --- */

    // 1. CREATE / JOIN
    $('btn-create').onclick = async () => {
      const code = $('inp-code-create').value.toUpperCase().trim();

      const body = {};
      if (code) body.code = code;

      const res = await api('/parties', 'POST', body);

      // Create as Spectator/Host Only
      state.code = res.code;
      state.playerId = null; // No player ID
      state.isSpectatorMode = true;

      // Navigate to /admin/:code
      navigate(`/admin/${res.code}`);

      startPolling();

      // Auto-fill code in Join tab for convenience
      $('inp-code').value = res.code;
      refreshGroups();
    };

    $('btn-join').onclick = async () => {
      const code = $('inp-code').value.toUpperCase().trim();
      const nick = $('inp-nick').value.trim();
      const groupIdx = $('inp-group').value;
      const newGroup = $('chk-newgroup').checked;

      if (!code || !nick) return alert('Code et Pseudo requis');

      await performJoin(code, nick, false, groupIdx, newGroup);
    };

    async function performJoin(code, nick, isHost, groupIdx, createGroup) {
      try {
        const body = { nickname: nick };

        if (createGroup) body.createGroup = true;
        else if (groupIdx) body.groupIndex = parseInt(groupIdx);

        const res = await api(`/parties/${code}/join`, 'POST', body);
        state.playerId = res.playerId;
        state.code = code;

        // Create server-side session and store token in cookie
        try {
          const sessionRes = await api('/sessions', 'POST', { playerId: res.playerId, code });
          if (sessionRes.token) {
            setSessionCookie(sessionRes.token);
          }
        } catch (e) {
          console.warn('Session creation failed:', e);
        }

        // Navigate to /party/:code
        navigate(`/party/${code}`);

        // Fetch snapshot immediately to show groups
        const snap = await api(`/parties/${code}`);
        state.snapshot = snap;
        render();

        startPolling();
      } catch (e) { console.error(e); }
    }

    async function refreshGroups() {
      const code = $('inp-code').value.toUpperCase().trim();
      if (code.length < 4) return;
      try {
        const p = await api(`/parties/${code}`);
        const sel = $('inp-group');
        sel.innerHTML = '<option value="" disabled selected>Choisir un groupe...</option>';
        p.groups.forEach(g => {
          const opt = document.createElement('option');
          opt.value = g.idx;
          opt.innerText = `Groupe ${g.idx} (${g.players.length} joueurs)`;
          sel.appendChild(opt);
        });
      } catch (e) { }
    }
    $('inp-code').oninput = refreshGroups;

    // 2. PREP (LOBBY)
    $('btn-submit-statements').onclick = async () => {
      const s1 = $('txt-s1').value;
      const s2 = $('txt-s2').value;
      const s3 = $('txt-s3').value;
      const lieIdx = parseInt(document.querySelector('input[name="lie"]:checked').value);

      if (!s1 || !s2 || !s3) return alert('Remplis les 3 √©nonc√©s !');

      const items = [
        { text: s1, isLie: lieIdx === 0 },
        { text: s2, isLie: lieIdx === 1 },
        { text: s3, isLie: lieIdx === 2 }
      ];

      await api(`/parties/${state.code}/statements`, 'POST', { items });
      state.hasSubmittedPrep = true;
      $('card-prep-statements').style.opacity = '0.5';
      $('card-prep-statements').style.pointerEvents = 'none';
      $('msg-prep-status').classList.remove('hidden');
      $('msg-lobby-autostart').classList.remove('hidden');
    };

    // 3. GAMEPLAY
    async function sendVote(statementId) {
      const round = getMyActiveRound();
      if (!round) return;

      try {
        await api(`/rounds/${round.id}/vote`, 'POST', { statementId });
        state.myVotes.add(round.id);
      } catch (error) {
        console.error('Vote failed:', error);
      }
      // Refresh snapshot immediately to show new round or scores
      try {
        const snap = await api(`/parties/${state.code}`);
        state.snapshot = snap;
        state._renderedRoundId = null; // Force re-render
        state._renderedRoundStatus = null;
        render();
      } catch (e) {
        console.error('Snapshot refresh failed:', e);
      }
    }

    /* --- SYNC & RENDER --- */
    function startPolling() {
      setInterval(async () => {
        if (!state.code) return;
        try {
          const snap = await api(`/parties/${state.code}`);
          state.snapshot = snap;
          render();
        } catch (e) {
          // Should be network error mostly
          setOffline(true);
        }
      }, 1000); // 1s polling
    }

    function render() {
      const s = state.snapshot;
      if (!s) return;

      // Meta header
      const me = state.playerId ? s.players.find(p => p.id === state.playerId) : null;
      const myGroup = s.groups.find(g => g.players.some(p => p.id === state.playerId));

      // Build header with group badge
      if (me && myGroup) {
        const groupColorClass = `group-color-${((myGroup.idx - 1) % 6) + 1}`;
        $('sessionMeta').innerHTML = `
          <div class="group-badge ${groupColorClass}">
            <span class="group-badge-icon">üë•</span>
            <span>Groupe ${myGroup.idx}</span>
          </div>
          <div class="session-info">Code: ${s.code} | ${me.nickname}</div>
        `;
      } else {
        $('sessionMeta').innerHTML = `<div class="session-info">Code: ${s.code} | ${me?.nickname || 'Spectateur'}</div>`;
      }

      // View Router Logic (myGroup already defined above)

      // Show live scoreboard for spectators during game, or hide it
      const shouldShowLiveScores = (s.status === 'RUNNING_PHASE1' || s.status === 'RUNNING_PHASE2') &&
                                    (!state.playerId || (myGroup && myGroup.status === 'DONE'));
      if (shouldShowLiveScores) {
        renderLiveScoreboard(s);
        renderPlayerStatusPanel(s);
        $('live-scoreboard').classList.remove('hidden');
      } else {
        $('live-scoreboard').classList.add('hidden');
      }

      // 1. Lobby
      if (s.status === 'LOBBY' || s.status === 'RUNNING_PHASE1_PREP') {
        switchView('lobby');
        renderLobby(s);
        // Hide statements input if spectator
        if (!me) {
          $('card-prep-statements').classList.add('hidden');
          $('msg-lobby-autostart').classList.remove('hidden');
          $('msg-lobby-autostart').innerText = "En tant que spectateur, vous voyez la salle d'attente.";
        } else {
          $('card-prep-statements').classList.remove('hidden');
        }
        return;
      }

      // 2. Running (Phase 1 & 2)
      if (s.status === 'RUNNING_PHASE1' || s.status === 'RUNNING_PHASE2') {
        // Are we inside a round ?
        if (myGroup && myGroup.status === 'DONE' && s.status === 'RUNNING_PHASE1') {
          // Group finished phase 1
          switchView('scores');
          renderScores(s);
          return;
        }

        const activeR = getMyActiveRound();

        if (activeR && (activeR.status === 'VOTING' || activeR.status === 'QUESTIONING')) {
          switchView('game');
          renderGameRound(activeR, s);
        } else if (!state.playerId) {
          // Spectator/Admin: show only tracking (scores + statuses), never statements
          switchView('scores');
          renderScores(s);
        } else {
          // If no active round (between rounds), check for lastReveal
          if (s.lastReveal) {
            switchView('reveal');
            renderReveal(s.lastReveal);
          } else {
            // Waiting / Spectator
            if (s.status === 'RUNNING_PHASE1' && !myGroup) {
              $('sessionMeta').innerText += ' (Spectateur)';
            }
            // Could show "Waiting for next round"
          }
        }
      }

      // 3. Finished
      if (s.status === 'FINISHED') {
        switchView('scores');
        renderScores(s);
      }
    }

    function renderLobby(s) {
      $('lbl-lobby-code').innerText = s.code;
      $('lbl-lobby-players').innerText = `${s.players.length} Joueurs`;

      // Update spectator link
      updateSpectatorLink();

      const list = $('list-lobby-players');
      list.innerHTML = '';
      const isSpectator = !state.playerId;

      s.players.forEach(p => {
        const row = document.createElement('div');
        row.className = 'list-item';
        row.style.display = 'grid';
        row.style.gridTemplateColumns = '1fr auto auto auto';
        row.style.gap = '12px';
        row.style.alignItems = 'center';

        const groupIdx = getGroupIdx(s, p.groupId);
        const groupColorClass = `group-color-${((groupIdx - 1) % 6) + 1}`;
        const isMe = p.id === state.playerId;
        const canRemove = isSpectator || !isMe;
        const st = getPlayerStatus(p, s);

        row.innerHTML = `
          <span style="display: flex; align-items: center; gap: 8px;">
            ${p.nickname}
            ${isMe ? '<span style="opacity: 0.6; font-size: 0.8em;">(vous)</span>' : ''}
          </span>
          <span class="group-badge ${groupColorClass}" style="font-size: 0.75rem; padding: 4px 10px;">
            üë• Groupe ${groupIdx}
          </span>
          <span class="player-status-badge ${st.cssClass}">${st.emoji} ${st.text}</span>
          ${canRemove ? `<button class="btn-remove-player" data-player-id="${p.id}" style="background: var(--danger); color: white; border: none; padding: 6px 10px; border-radius: 6px; cursor: pointer; font-size: 0.75rem; white-space: nowrap;" aria-label="Retirer ${p.nickname}">‚úï</button>` : '<span></span>'}
        `;
        list.appendChild(row);
      });

      // Attach event listeners to remove buttons
      document.querySelectorAll('.btn-remove-player').forEach(btn => {
        btn.onclick = async () => {
          const playerIdToRemove = btn.getAttribute('data-player-id');
          const playerName = s.players.find(p => p.id === playerIdToRemove)?.nickname;
          if (confirm(`Retirer ${playerName} de la partie ?`)) {
            await api(`/parties/${s.code}/players/${playerIdToRemove}`, 'DELETE');
          }
        };
      });
    }

    function renderGameRound(round, s) {
      const isSpectator = !state.playerId;
      const isNarrator = !isSpectator && round.narratorId === state.playerId;
      const hasVoted = !isSpectator && round.votes && round.votes.some(v => v.playerId === state.playerId);
      const voteCount = round.votes ? round.votes.length : 0;

      // Skip full DOM rebuild if same round, same status, same vote count (avoids flickering)
      if (state._renderedRoundId === round.id &&
          state._renderedRoundStatus === round.status &&
          state._renderedVoteCount === voteCount) {
        return;
      }
      state._renderedRoundId = round.id;
      state._renderedRoundStatus = round.status;
      state._renderedVoteCount = voteCount;

      const narrator = s.players.find(p => p.id === round.narratorId);
      $('lbl-narrator-name').innerText = `Au tour de ${narrator?.nickname || 'Inconnu'} d'√©noncer ses v√©rit√©s/mensonge`;

      const list = $('list-vote-options');
      list.innerHTML = '';

      if (round.status === 'QUESTIONING') {
        $('msg-host-wait').classList.remove('hidden');
        $('msg-vote-wait').classList.add('hidden');
        return;
      }

      $('msg-host-wait').classList.add('hidden');

      if (isSpectator) {
        const totalPlayers = s.players.filter(p => p.id !== round.narratorId).length;
        $('msg-vote-wait').innerText = `üëÄ Spectateur ‚Äì ${voteCount}/${totalPlayers} votes re√ßus`;
        $('msg-vote-wait').classList.remove('hidden');
      } else if (isNarrator) {
        $('msg-vote-wait').innerText = "C'est ton tour. Reste de marbre !";
        $('msg-vote-wait').classList.remove('hidden');
      } else if (hasVoted) {
        $('msg-vote-wait').innerText = "Vote enregistr√©. Suspense...";
        $('msg-vote-wait').classList.remove('hidden');
      } else {
        $('msg-vote-wait').classList.add('hidden');
      }

      if (round.statements) {
        round.statements.forEach(stmt => {
          const btn = document.createElement('div');
          btn.className = 'statement-card';
          btn.innerText = stmt.text;

          if (isSpectator || hasVoted || isNarrator) {
            btn.style.opacity = '0.5';
            btn.style.cursor = 'default';
          } else {
            btn.onclick = async () => {
              if (btn.dataset.voting === 'true') return;
              btn.dataset.voting = 'true';

              const allBtns = list.querySelectorAll('.statement-card');
              allBtns.forEach(b => {
                b.style.pointerEvents = 'none';
                b.style.opacity = '0.5';
              });

              btn.style.opacity = '0.7';
              btn.style.cursor = 'wait';
              btn.innerText = '‚è≥ Envoi du vote...';

              await sendVote(stmt.id);
            };
          }

          list.appendChild(btn);
        });
      }
    }

    function renderReveal(revealData) {
      // revealData is from snapshot.lastReveal structure
      const div = $('card-reveal-info');
      div.innerHTML = `
           <p style="text-transform:uppercase; font-size: 0.9rem; letter-spacing:1px; margin-bottom:12px;">Le mensonge de <strong style="color:var(--txt-main);">${revealData.narratorNickname}</strong> √©tait :</p>
           <h3 style="font-size: 1.5rem; color: var(--accent-primary); margin-bottom: 24px;">¬´ ${revealData.lieText || '???'} ¬ª</h3>
           <div class="result-row winner" style="justify-content: center;">
             <span>La v√©rit√© √©clate !</span>
           </div>
         `;
    }

    function renderScores(s) {
      const list = $('list-scores');
      list.innerHTML = '';

      // Use leaderboard from snapshot (already sorted by server)
      const lb = s.leaderboard || [];

      lb.forEach((entry, idx) => {
        const row = document.createElement('div');
        row.className = 'result-row';
        if (idx === 0) row.classList.add('winner');

        row.innerHTML = `
             <div style="display:flex; align-items:center; gap:12px;">
               <span style="font-weight:700; width:20px;">#${idx + 1}</span>
               <span>${entry.nickname}</span>
             </div>
             <span class="score-badge">${entry.total || 0} pts</span>
           `;
        list.appendChild(row);
      });
    }

    function renderLiveScoreboard(s) {
      const list = $('live-scores-list');
      list.innerHTML = '';

      // Use leaderboard from snapshot (already sorted by server)
      const lb = s.leaderboard || [];

      if (lb.length === 0) {
        list.innerHTML = '<p style="text-align:center; color:var(--txt-muted); font-size:0.85rem;">Aucun joueur</p>';
        return;
      }

      lb.forEach((entry, idx) => {
        const row = document.createElement('div');
        row.className = 'score-row';
        if (idx === 0 && entry.total > 0) row.classList.add('top');

        row.innerHTML = `
          <div class="player-info">
            <span class="rank">#${idx + 1}</span>
            <span class="nickname">${entry.nickname}</span>
          </div>
          <span class="points">${entry.total || 0}</span>
        `;

        if (entry.phase1 > 0 || entry.phase2 > 0) {
          const details = document.createElement('div');
          details.className = 'score-details';
          details.innerHTML = `P1: ${entry.phase1} | P2: ${entry.phase2}`;
          row.appendChild(details);
        }

        list.appendChild(row);
      });
    }

    /**
     * Determine the live status of a player based on snapshot state.
     * @param {Object} player - { id, nickname, groupId, isHost }
     * @param {Object} s      - full snapshot
     * @returns {{ emoji: string, text: string, cssClass: string }}
     */
    function getPlayerStatus(player, s) {
      const partyStatus = s.status;

      // --- LOBBY / PREP ---
      if (partyStatus === 'LOBBY' || partyStatus === 'RUNNING_PHASE1_PREP') {
        const submitted = (s.phaseTiming?.phase1Prep?.submittedPlayers || [])
          .some(sp => sp.playerId === player.id);
        if (submitted) return { emoji: '‚úÖ', text: 'Pr√™t', cssClass: 'status-ready' };
        if (partyStatus === 'RUNNING_PHASE1_PREP') return { emoji: '‚úèÔ∏è', text: 'R√©dige...', cssClass: 'status-writing' };
        return { emoji: '‚è≥', text: 'En attente', cssClass: 'status-waiting' };
      }

      // --- FINISHED ---
      if (partyStatus === 'FINISHED') {
        return { emoji: 'üèÅ', text: 'Termin√©', cssClass: 'status-finished' };
      }

      // --- RUNNING PHASE 1 ---
      if (partyStatus === 'RUNNING_PHASE1') {
        const group = s.groups.find(g => g.id === player.groupId);
        if (!group) return { emoji: '‚è≥', text: 'En attente', cssClass: 'status-waiting' };
        if (group.status === 'DONE') return { emoji: 'üèÅ', text: 'Groupe termin√©', cssClass: 'status-done' };
        const round = group.currentRound;
        if (!round) return { emoji: '‚è≥', text: 'Entre les manches', cssClass: 'status-waiting' };
        if (round.narratorId === player.id) return { emoji: 'üé§', text: 'Narrateur', cssClass: 'status-narrator' };
        if (round.status === 'QUESTIONING') return { emoji: 'üëÇ', text: '√âcoute', cssClass: 'status-listening' };
        if (round.status === 'VOTING') {
          const hasVoted = (round.voterIds || []).includes(player.id);
          return hasVoted
            ? { emoji: '‚úÖ', text: 'A vot√©', cssClass: 'status-voted' }
            : { emoji: 'üó≥Ô∏è', text: 'Vote...', cssClass: 'status-voting' };
        }
        return { emoji: '‚è≥', text: 'En attente', cssClass: 'status-waiting' };
      }

      // --- RUNNING PHASE 2 ---
      if (partyStatus === 'RUNNING_PHASE2') {
        const round = s.phase2CurrentRound;
        if (!round) return { emoji: '‚è≥', text: 'Entre les manches', cssClass: 'status-waiting' };
        if (round.narratorId === player.id) return { emoji: 'üé§', text: 'Narrateur', cssClass: 'status-narrator' };
        if (round.status === 'QUESTIONING') return { emoji: 'üëÇ', text: '√âcoute', cssClass: 'status-listening' };
        if (round.status === 'VOTING') {
          const hasVoted = (round.voterIds || []).includes(player.id);
          return hasVoted
            ? { emoji: '‚úÖ', text: 'A vot√©', cssClass: 'status-voted' }
            : { emoji: 'üó≥Ô∏è', text: 'Vote...', cssClass: 'status-voting' };
        }
        return { emoji: '‚è≥', text: 'En attente', cssClass: 'status-waiting' };
      }

      return { emoji: '‚ùì', text: 'Inconnu', cssClass: 'status-waiting' };
    }

    function renderPlayerStatusPanel(s) {
      const list = $('player-status-list');
      if (!list) return;
      list.innerHTML = '';

      s.players.forEach(p => {
        const st = getPlayerStatus(p, s);
        const groupIdx = getGroupIdx(s, p.groupId);
        const groupColorClass = `group-color-${((groupIdx - 1) % 6) + 1}`;

        const row = document.createElement('div');
        row.className = 'player-status-row';
        row.innerHTML = `
          <span class="group-badge ${groupColorClass}" style="font-size: 0.65rem; padding: 2px 6px;">G${groupIdx}</span>
          <span class="ps-name">${p.nickname}</span>
          <span class="player-status-badge ${st.cssClass}" aria-label="${st.text}">${st.emoji} ${st.text}</span>
        `;
        list.appendChild(row);
      });
    }

    function getGroupIdx(s, gid) {
      const g = s.groups.find(x => x.id === gid);
      try {
        return g ? g.idx : '?';
      } catch { return '?'; }
    }

    function getMyActiveRound() {
      if (!state.snapshot) return null;
      const s = state.snapshot;
      // See backend logic: snapshot returns 'groups' which contain 'currentRound'
      const grp = s.groups.find(g => g.players.some(p => p.id === state.playerId));
      return grp ? grp.currentRound : null;
    }

    /* --- SPECTATOR LINK --- */
    function updateSpectatorLink() {
      if (!state.code) return;
      const url = `${window.location.origin}/admin/${state.code}`;
      $('inp-spectator-url').value = url;
    }

    $('btn-copy-spectator').onclick = async () => {
      const url = $('inp-spectator-url').value;
      try {
        await navigator.clipboard.writeText(url);
        $('msg-copy-success').classList.remove('hidden');
        setTimeout(() => {
          $('msg-copy-success').classList.add('hidden');
        }, 2000);
      } catch (e) {
        // Fallback for older browsers
        $('inp-spectator-url').select();
        document.execCommand('copy');
        $('msg-copy-success').classList.remove('hidden');
        setTimeout(() => {
          $('msg-copy-success').classList.add('hidden');
        }, 2000);
      }
    };

    /* --- HANDLE BROWSER BACK/FORWARD --- */
    window.addEventListener('popstate', () => {
      // On back/forward, re-init from URL
      window.location.reload();
    });

    /* --- INIT ON PAGE LOAD --- */
    window.addEventListener('DOMContentLoaded', () => {
      initFromUrl();
    });

  </script>
</body>

</html>